<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Tushar's personal blog"><title>Mutable default arguments in Python | Tushar | Blog</title><link rel="stylesheet" type="text/css" href="/blog//css/normalize.css"><link rel="stylesheet" type="text/css" href="/blog//css/highlight.css"><link rel="stylesheet" type="text/css" href="/blog//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/blog/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/blog/." class="title">Tushar | Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/blog/" class="sidebar-nav-item">Home</a><a href="/blog/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Mutable default arguments in Python</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-08-21</div><div class="post-tags"><a class="post-tag-link" href="/blog/tags/Python/">Python</a></div></div></div><article><div class="container post"><p>Recently, I came across an interesting feature in Python and thought I should share it with everyone.</p>
<p>Suppose we have a code snippet that looks like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(default_immutable_arg=<span class="string">"Hello"</span>,</span></span></div><div class="line">         default_mutable_arg=&#123;&#125;):</div><div class="line">    key = <span class="string">'some_key'</span></div><div class="line">    default_immutable_arg += <span class="string">"!"</span></div><div class="line">    print(default_immutable_arg),</div><div class="line">    <span class="keyword">if</span> default_mutable_arg.get(key, <span class="keyword">None</span>):</div><div class="line">        print(<span class="string">"&#123;key&#125; exists"</span>.format(key=key))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(<span class="string">"&#123;key&#125; doesn't exist"</span>.format(key=key))</div><div class="line">        default_mutable_arg[key] = <span class="string">"some_value"</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</div><div class="line">    func()</div></pre></td></tr></table></figure>
<p>Before reading further, please stop and go through the code snippet carefully.</p>
<p>Now, What output do you expect from the above snippet? There is a high probability (unless you are a Python wizard!) that you might expect the output to be<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Hello! some_key doesn<span class="symbol">'t</span> exist</div><div class="line">Hello! some_key doesn<span class="symbol">'t</span> exist</div><div class="line">Hello! some_key doesn<span class="symbol">'t</span> exist</div></pre></td></tr></table></figure></p>
<p>Well, if that’s what you expected, then you are wrong!</p>
<p>The correct output is<br><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Hello! some_key doesn't exist</div><div class="line">Hello! some_key exists</div><div class="line">Hello! some_key exists</div></pre></td></tr></table></figure></p>
<p>Interesting isn’t it? Let’s dig a little deeper and find out why this happens.</p>
<p>Perhaps, it’s quite known now.</p>
<blockquote>
<p>Expressions in default arguments are calculated when the function is defined, not when it’s called.</p>
</blockquote>
<p>Before I explain further, let’s verify the above statement quickly:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_func</span><span class="params">(arg=time.time<span class="params">()</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> arg</div><div class="line"></div><div class="line"><span class="keyword">print</span> [time_func() <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>)]</div></pre></td></tr></table></figure></p>
<p>For me the output looks like<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="number">1471723451.85</span>, <span class="number">1471723451.85</span>, <span class="number">1471723451.85</span>]</div><div class="line"><span class="comment"># Notice the exact same timestamps here.</span></div></pre></td></tr></table></figure></p>
<p>Clearly, <code>arg</code> was calculated when <code>time_func</code> was defined and not when it’s called otherwise you would expect <code>arg</code> to be different each time it’s executed.</p>
<p>Coming to our <code>func</code> example. When <code>def</code> statement is executed a new function object is created, bound to the name <code>func</code> and stored in the namespace of the module. Within the function object, <em>for each argument object with a default value, an object is created that holds the default value.</em></p>
<p>In the above example, a <em>string object</em> (“Hello!”) and an empty <em>dictionary object</em> is created as a default for <code>default_immutable_arg</code> and <code>default_mutable_arg</code> respectively.</p>
<p>Now, whenever <code>func</code> is called without arguments, the arguments will use the values from their default bounded object i.e <code>default_immutable_arg</code> will always be “Hello!” but <code>default_mutable_arg</code> <em>may</em> change. It’s because of the fact that string objects are immutable whereas a dictionary objects are mutable. So whenever in line 4, we append “!” to <code>default_immutable_arg</code>, <em>a new string object is created and returned</em> which is then printed in next line, keeping default string object’s value still intact.</p>
<p>This isn’t the case with mutable dictionary objects. The first time we execute <code>func</code> without any arguments, <code>default_mutable_arg</code> takes its value from default dictionary object which is <code>{}</code> now. Hence, the <code>else</code> block will be executed. Since the dictionary objects are mutable, the <code>else</code> block <em>changes</em> the default dictionary object. So in the next execution of the function, when <code>default_mutable_arg</code> reads from default dictionary object, it receives <code>{&#39;some_key&#39;:&#39;some_value&#39;}</code> and not <code>{}</code>. Interesting huh? Well that’s the explanation! :)</p>
<h5 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h5><p>Don’t use the mutable argument objects as default arguments! Simple! So how do we improve our <code>func</code> ? Well, just use <code>None</code> as default argument value and check for <code>None</code> inside function body to determine if the arguments were passed or not.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(default_immutable_arg=<span class="string">"Hello"</span>,</span></span></div><div class="line">         default_mutable_arg=None):</div><div class="line">    default_mutable_arg = (&#123;&#125; <span class="keyword">if</span> default_mutable_arg <span class="keyword">is</span> <span class="keyword">None</span></div><div class="line">                              <span class="keyword">else</span> default_mutable_arg)</div><div class="line">    <span class="comment"># rest is same..</span></div></pre></td></tr></table></figure></p>
<p>Now, you can imagine what would happen if we overlook this feature in defining class methods. Clearly, all the class instances will share the same references to the same object which isn’t something you’d want to have in the first place! :)</p>
<p>I hope that was fun,</p>
<p>Cheers!</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'gtushar';
var disqus_identifier = '2016/08/21/Mutable-default-arguments-in-Python/';
var disqus_title = 'Mutable default arguments in Python';
var disqus_url = 'http://gtushar.co/blog/blog/2016/08/21/Mutable-default-arguments-in-Python/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:tushar.rishav@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="http://twitter.com/tushar_rishav" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/tushar-rishav" target="_blank"><i class="fa fa-github"></i></a><a href="/blog/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Tushar | Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-77419685-1');ga('send','pageview');</script></html>